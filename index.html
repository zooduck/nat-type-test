<!DOCTYPE html>
<html>
  <body>
    <main id="nat-info">
      You are behind a <span id="nat-type">???</span> NAT.
    </main>
    <script type="module">
      const getNATType = () => {
        return new Promise((resolve) => {
          const relatedPorts = new Map();
          const connection = new RTCPeerConnection({
            iceServers: [
              { urls: 'stun:stun1.l.google.com:19302' },
              { urls: 'stun:stun2.l.google.com:19302' }
            ]
          });
          connection.createDataChannel('bananas');
          connection.onicecandidate = (event) => {
            const { candidate, target: connection } = event;
            if (candidate && candidate.type === 'srflx') {
              const { relatedPort } = candidate;
              if (!relatedPorts.has(relatedPort)) {
                relatedPorts.set(relatedPort, []);
              }
              relatedPorts.get(relatedPort).push(candidate);
            }

            if (connection.iceGatheringState === 'complete') {
              const isSymmetricNAT = Array.from(relatedPorts.entries()).some(([relatedPort, candidates]) => {
                return candidates.length === 1;
              });

              resolve(isSymmetricNAT ? 'symmetric' : 'non-symmetric');
            }
          }
          connection.createOffer().then((offer) =>  {
            connection.setLocalDescription(offer);
          });
        });
      };

      const natType = await getNATType();
      document.getElementById('nat-type').textContent = natType;
    </script>
  </body>
</html>